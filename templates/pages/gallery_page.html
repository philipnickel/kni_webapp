{% extends "base.html" %}
{% load wagtailcore_tags wagtailsettings_tags %}

{% block content %}

<!-- Hero Section -->
<div class="bg-hero text-inverse relative">
  <div class="absolute inset-0 hero-overlay"></div>
  <div class="relative max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-24">
    <div class="text-center">
      <h1 class="text-4xl lg:text-6xl font-bold font-craft leading-tight mb-6">{{ page.title }}</h1>
      {% if page.intro %}
        <div class="text-xl lg:text-2xl text-inverse-muted max-w-3xl mx-auto">{{ page.intro|richtext }}</div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Projects Grid Section -->
<div class="bg-surface py-16">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    {% if project_pages %}
      <!-- Project Stats Bar -->
      <div class="mb-8 text-center">
        <div class="inline-flex items-center bg-surface-soft rounded-2xl px-6 py-3 shadow-construction">
          <svg class="w-5 h-5 text-primary mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
          </svg>
          <span class="font-medium text-body" id="project-count">{{ project_pages|length }} færdige projekter</span>
        </div>
      </div>

      <!-- Tag Filter Section -->
      <div class="mb-8" id="filter-section">
        <div class="text-center mb-6">
          <h3 class="text-lg font-semibold text-slate-900 mb-2">Filtrer efter kategori</h3>
          <p class="text-slate-600 text-sm">Vælg en kategori for at se relaterede projekter</p>
        </div>
        
        <div class="flex flex-wrap justify-center gap-2 mb-8" id="tag-filters">
          <!-- All projects button (always active by default) -->
          <button 
            class="tag-filter active px-4 py-2 rounded-full text-sm font-medium transition-all duration-300 bg-slate-900 text-white shadow-lg hover:shadow-xl"
            data-tag="all"
          >
            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
            </svg>
            Alle projekter
            <span class="ml-1.5 px-1.5 py-0.5 text-xs bg-white/20 rounded" id="all-count">{{ project_pages|length }}</span>
          </button>
          
          <!-- Tag buttons will be generated by JavaScript from project data -->
        </div>
      </div>

      <!-- Projects Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {% for project in project_pages %}
          <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 cursor-pointer"
               data-tags="{% for tag in project.tags.all %}{{ tag.slug }}{% if not forloop.last %} {% endif %}{% endfor %}"
               data-project-id="{{ project.id }}"
               data-project-title="{{ project.title }}"
               data-project-description="{{ project.description|striptags }}"
               data-project-date="{{ project.date|date:'Y' }}"
               data-project-type="{{ project.location }}"
               data-project-images="{% for item in project.images.all %}{{ item.image.url }}{% if not forloop.last %}|{% endif %}{% endfor %}"
               data-project-tags="{% for tag in project.tags.all %}{{ tag.name }}{% if not forloop.last %}, {% endif %}{% endfor %}"
               onclick="openProjectModal('{{ project.id }}')">
            
            <!-- Card Image -->
            <figure class="relative">
              {% if project.get_first_image %}
                {% load wagtailimages_tags %}
                {% image project.get_first_image width-400 as project_img %}
                <img src="{{ project_img.url }}" alt="{{ project.title }}" 
                     class="w-full h-48 object-cover">
              {% else %}
                <div class="w-full h-48 bg-gradient-to-br from-base-200 to-base-300 flex items-center justify-center">
                  <div class="text-center">
                    <svg class="w-12 h-12 text-base-content/40 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span class="text-base-content/60 text-sm">{{ project.title }}</span>
                  </div>
                </div>
              {% endif %}
              
              <!-- Year Badge -->
              {% if project.date %}
                <div class="absolute top-3 right-3">
                  <div class="badge badge-primary">{{ project.date|date:"Y" }}</div>
                </div>
              {% endif %}
            </figure>
            
            <!-- Card Body -->
            <div class="card-body p-4">
              <h3 class="card-title text-lg">{{ project.title }}</h3>
              
              <!-- Project Meta -->
              <div class="flex items-center gap-4 text-sm text-base-content/70 mb-3">
                {% if project.location %}
                  <div class="flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span>{{ project.location }}</span>
                  </div>
                {% endif %}
              </div>
              
              {% if project.description %}
                <p class="text-base-content/80 text-sm mb-4 line-clamp-2">{{ project.description|striptags|truncatewords:15 }}</p>
              {% endif %}
              
              {% if project.materials %}
                <div class="text-xs text-base-content/70 mb-3">
                  <span class="font-medium">Materialer:</span> {{ project.materials|truncatewords:8 }}
                </div>
              {% endif %}
              
              <!-- Card Actions -->
              <div class="card-actions justify-end">
                <button class="btn btn-primary btn-sm">
                  Se projekt
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
      
      <!-- Call to Action Section -->
      <div class="mt-16 text-center">
        <div class="bg-surface-soft rounded-2xl shadow-construction p-8 max-w-2xl mx-auto border border-default">
          <h3 class="text-2xl font-bold text-body mb-4">Har du et projekt i tankerne?</h3>
          <p class="text-subtle mb-6">Vi vil gerne høre om dit næste projekt og diskutere, hvordan vi kan hjælpe dig med at realisere dine ideer.</p>
          <a href="/kontakt/" class="btn-primary px-8 py-3 rounded-lg shadow-lg hover:shadow-xl transition-shadow">
            Få et uforpligtende tilbud
          </a>
        </div>
      </div>
      
    {% else %}
      <!-- Empty State -->
      <div class="text-center py-24">
        <div class="max-w-md mx-auto">
          <div class="w-24 h-24 bg-surface-soft rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-12 h-12 text-subtle" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
            </svg>
          </div>
          <h3 class="text-xl font-bold text-body mb-4">Ingen projekter endnu</h3>
          <p class="text-subtle mb-6">Vi arbejder på at tilføje vores seneste projekter. Kom tilbage snart for at se vores arbejde!</p>
          <a href="/kontakt/" class="btn-primary px-6 py-3 rounded-lg">Kontakt os</a>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<!-- Enhanced CSS for Masonry Grid and Animations -->
<style>
/* Line clamp utilities */
.line-clamp-1 {
  display: -webkit-box;
  -webkit-line-clamp: 1;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.line-clamp-3 {
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* Simplified CSS Grid Masonry Layout */
.masonry-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 2rem;
  align-items: start;
}

.masonry-item {
  display: block;
  position: relative;
  width: 100%;
}

.masonry-item img {
  width: 100%;
  height: auto;
  object-fit: cover;
  border-radius: 1rem;
  display: block;
}

/* Fallback for browsers that support masonry */
@supports (grid-template-rows: masonry) {
  .masonry-container {
    grid-template-rows: masonry;
  }
}

/* Responsive grid adjustments */
@media (max-width: 1280px) {
  .masonry-container {
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  }
}

@media (max-width: 768px) {
  .masonry-container {
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1.5rem;
  }
}

@media (max-width: 480px) {
  .masonry-container {
    grid-template-columns: 1fr;
    gap: 1rem;
  }
}

/* Enhanced hover animations */
.masonry-item {
  will-change: transform, box-shadow;
  transform-origin: center center;
}

.masonry-item:hover {
  animation: float 0.5s ease-out;
}

@keyframes float {
  0% { transform: translateY(0) scale(1); }
  50% { transform: translateY(-4px) scale(1.02); }
  100% { transform: translateY(-8px) scale(1); }
}

/* Staggered animation for grid items */
.masonry-item:nth-child(1) { animation-delay: 0ms; }
.masonry-item:nth-child(2) { animation-delay: 100ms; }
.masonry-item:nth-child(3) { animation-delay: 200ms; }
.masonry-item:nth-child(4) { animation-delay: 300ms; }
.masonry-item:nth-child(5) { animation-delay: 400ms; }
.masonry-item:nth-child(6) { animation-delay: 500ms; }

/* Smooth entrance animation */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.masonry-item {
  animation: fadeInUp 0.6s ease-out both;
}

/* Image loading state */
.masonry-item img[src=""] {
  background: linear-gradient(90deg, #f0f0f0 25%, transparent 37%, #f0f0f0 63%);
  background-size: 400% 100%;
  animation: shimmer 1.5s ease-in-out infinite;
}

@keyframes shimmer {
  0% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* Custom scrollbar for better aesthetics */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* Focus states for accessibility */
.masonry-item a:focus {
  outline: 2px solid #3b82f6;
  outline-offset: 4px;
  border-radius: 1rem;
}

/* Performance optimizations */
.masonry-item * {
  will-change: auto;
}

.group:hover .group-hover\:scale-110 {
  will-change: transform;
}
</style>

<!-- JavaScript for enhanced interactions and filtering -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Get project cards and filter elements
  const projectsGrid = document.querySelector('.grid');
  const items = projectsGrid.querySelectorAll('.card');
  const tagFiltersContainer = document.getElementById('tag-filters');
  const projectCountElement = document.getElementById('project-count');
  
  // Extract all unique tags from projects
  let allTags = new Set();
  let tagCounts = {};
  
  items.forEach(item => {
    const tags = item.dataset.tags.trim();
    if (tags) {
      tags.split(' ').forEach(tag => {
        if (tag) {
          allTags.add(tag);
          tagCounts[tag] = (tagCounts[tag] || 0) + 1;
        }
      });
    }
  });
  
  // Generate tag filter buttons with Frostbite styling
  function generateTagButtons() {
    // Clear existing tag buttons (keep the "All" button)
    const allButton = tagFiltersContainer.querySelector('[data-tag="all"]');
    tagFiltersContainer.innerHTML = '';
    tagFiltersContainer.appendChild(allButton);
    
    // Add individual tag buttons
    Array.from(allTags).sort().forEach(tag => {
      const button = document.createElement('button');
      button.className = 'tag-filter btn btn-outline btn-sm';
      button.dataset.tag = tag;
      
      // Capitalize first letter of tag for display
      const displayName = tag.charAt(0).toUpperCase() + tag.slice(1).replace('-', ' ');
      
      button.innerHTML = `
        ${displayName}
        <div class="badge badge-primary badge-sm ml-1">${tagCounts[tag]}</div>
      `;
      
      tagFiltersContainer.appendChild(button);
    });
  }
  
  // Initialize tag buttons
  if (allTags.size > 0) {
    generateTagButtons();
  } else {
    // Hide filter section if no tags
    document.getElementById('filter-section').style.display = 'none';
  }
  
  // Filter functionality
  function filterProjects(selectedTag) {
    let visibleCount = 0;
    
    items.forEach((item, index) => {
      const itemTags = item.dataset.tags.trim().split(' ');
      const shouldShow = selectedTag === 'all' || itemTags.includes(selectedTag);
      
      if (shouldShow) {
        item.style.display = 'block';
        item.style.opacity = '1';
        item.style.transform = 'translateY(0)';
        visibleCount++;
      } else {
        item.style.opacity = '0';
        item.style.transform = 'translateY(20px)';
        setTimeout(() => {
          item.style.display = 'none';
        }, 300);
      }
    });
    
    // Update project count
    const countText = visibleCount === 1 ? 'projekt' : 'projekter';
    projectCountElement.textContent = `${visibleCount} ${countText}`;
    
    // Update active button state with Frostbite classes
    document.querySelectorAll('.tag-filter').forEach(btn => {
      btn.classList.remove('btn-primary');
      btn.classList.add('btn-outline');
    });
    
    const activeButton = document.querySelector(`[data-tag="${selectedTag}"]`);
    if (activeButton) {
      activeButton.classList.remove('btn-outline');
      activeButton.classList.add('btn-primary');
    }
  }
  
  // Add click event listeners to filter buttons
  tagFiltersContainer.addEventListener('click', function(e) {
    if (e.target.closest('.tag-filter')) {
      const button = e.target.closest('.tag-filter');
      const selectedTag = button.dataset.tag;
      filterProjects(selectedTag);
    }
  });
  
  // Add staggered animation for cards
  items.forEach((item, index) => {
    item.style.animationDelay = `${index * 100}ms`;
    item.classList.add('animate-fade-in-up');
  });
  
  // Add smooth scroll behavior for internal links
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        target.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    });
  });
  
  // Add URL hash support for direct tag linking
  function handleHashChange() {
    const hash = window.location.hash.substring(1);
    if (hash && hash.startsWith('tag-')) {
      const tag = hash.replace('tag-', '');
      if (allTags.has(tag) || tag === 'all') {
        filterProjects(tag);
      }
    }
  }
  
  window.addEventListener('hashchange', handleHashChange);
  handleHashChange(); // Check initial hash
});
</script>
{# Include shared project modal #}
{% include "components/project_modal.html" %}
{% endblock %}