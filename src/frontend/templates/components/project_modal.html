{# Shared Project Modal and scripts #}
<div id="projectModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
  <!-- Backdrop -->
  <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" onclick="closeProjectModal()"></div>
  
  <!-- Modal Container -->
  <div class="flex min-h-full items-center justify-center p-2 sm:p-4">
    <div class="relative bg-white rounded-xl shadow-2xl max-w-7xl w-full max-h-[90vh] overflow-y-auto transform transition-all">
      
      <!-- Close Button -->
      <button onclick="closeProjectModal()" class="absolute top-4 right-4 z-10 bg-white/90 hover:bg-white rounded-full p-2 shadow-lg transition-colors">
        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>

      <!-- Modal Content -->
      <div class="flex flex-col lg:flex-row min-h-0 flex-1">
        
        <!-- Featured Image Section -->
        <div class="lg:w-2/3 relative flex-shrink-0">
          <div id="modalImageContainer" class="modal-image-container">
            <img id="modalFeaturedImage" src="" alt="">
            
            <!-- Image Navigation -->
            <div id="imageNavigation" class="absolute inset-x-4 top-1/2 transform -translate-y-1/2 flex justify-between hidden">
              <button onclick="previousImage()" class="bg-white/90 hover:bg-white rounded-full p-2 shadow-lg transition-colors">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
              </button>
              <button onclick="nextImage()" class="bg-white/90 hover:bg-white rounded-full p-2 shadow-lg transition-colors">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>

            <!-- Image Counter -->
            <div id="imageCounter" class="absolute bottom-4 right-4 bg-black/60 text-white text-sm px-3 py-1 rounded-full hidden">
              <span id="currentImageIndex">1</span> / <span id="totalImages">1</span>
            </div>
          </div>

          <!-- Image Thumbnails -->
          <div id="imageThumbnails" class="flex gap-2 p-4 overflow-x-auto hidden"></div>
        </div>

        <!-- Project Details Section -->
        <div class="lg:w-1/3 p-6 lg:p-8 overflow-y-auto flex-shrink-0 min-h-0">
          <div class="space-y-6">
            
            <!-- Header -->
            <div>
              <h2 id="modalTitle" class="text-2xl font-bold text-gray-900 mb-2"></h2>
              <div class="flex items-center gap-2 text-sm text-gray-600">
                <span id="modalDate"></span>
                <span id="modalTypeSeparator" class="hidden">•</span>
                <span id="modalType"></span>
              </div>
            </div>

            <!-- Description -->
            <div>
              <h3 class="text-sm font-semibold text-gray-900 mb-2">Beskrivelse</h3>
              <p id="modalDescription" class="text-gray-700 leading-relaxed"></p>
            </div>

            <!-- Nøgleord (tags) -->
            <div id="modalTagsContainer" class="hidden">
              <h3 class="text-sm font-semibold text-gray-900 mb-2">Nøgleord</h3>
              <div id="modalTags" class="flex flex-wrap gap-2"></div>
            </div>

            <!-- CTA -->
            <div class="pt-4 border-t border-gray-200">
              <a href="/fa-tilbud/" class="w-full btn-primary text-center block py-3">
                Få lignende projekt
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let currentProjectImages = [];
let currentImageIndex = 0;

function openProjectModal(projectId) {
  const projectCard = document.querySelector(`[data-project-id="${projectId}"]`);
  if (!projectCard) return;

  // Data
  const title = projectCard.dataset.projectTitle || '';
  const description = projectCard.dataset.projectDescription || '';
  const date = projectCard.dataset.projectDate || '';
  const type = projectCard.dataset.projectType || '';
  const images = (projectCard.dataset.projectImages || '').split('|').filter(img => img.trim());
  const tags = projectCard.dataset.projectTags || '';

  // Populate header
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalDescription').textContent = description;
  document.getElementById('modalDate').textContent = date;
  document.getElementById('modalType').textContent = type;
  if (date && type) { document.getElementById('modalTypeSeparator').classList.remove('hidden'); }
  else { document.getElementById('modalTypeSeparator').classList.add('hidden'); }

  // Images
  currentProjectImages = images;
  currentImageIndex = 0;
  if (images.length > 0) {
    document.getElementById('modalFeaturedImage').src = images[0];
    if (images.length > 1) {
      document.getElementById('imageNavigation').classList.remove('hidden');
      document.getElementById('imageCounter').classList.remove('hidden');
      document.getElementById('totalImages').textContent = images.length;
      updateImageCounter();
      setupThumbnails(images);
    } else {
      document.getElementById('imageNavigation').classList.add('hidden');
      document.getElementById('imageCounter').classList.add('hidden');
      document.getElementById('imageThumbnails').classList.add('hidden');
    }
  }

  // Tags in modal only
  if (tags) {
    const tagsArray = tags.split(',').map(t => t.trim()).filter(Boolean);
    const tagsContainer = document.getElementById('modalTags');
    tagsContainer.innerHTML = '';
    tagsArray.forEach(tag => {
      const el = document.createElement('span');
      el.className = 'inline-block px-2 py-1 text-xs bg-surface-soft text-subtle rounded-md';
      el.textContent = tag;
      tagsContainer.appendChild(el);
    });
    if (tagsArray.length) document.getElementById('modalTagsContainer').classList.remove('hidden');
    else document.getElementById('modalTagsContainer').classList.add('hidden');
  } else {
    document.getElementById('modalTagsContainer').classList.add('hidden');
  }

  // Show modal
  document.getElementById('projectModal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeProjectModal() {
  document.getElementById('projectModal').classList.add('hidden');
  document.body.style.overflow = 'auto';
}

function previousImage() {
  if (currentProjectImages.length <= 1) return;
  currentImageIndex = (currentImageIndex - 1 + currentProjectImages.length) % currentProjectImages.length;
  updateMainImage();
}

function nextImage() {
  if (currentProjectImages.length <= 1) return;
  currentImageIndex = (currentImageIndex + 1) % currentProjectImages.length;
  updateMainImage();
}

function updateMainImage() {
  document.getElementById('modalFeaturedImage').src = currentProjectImages[currentImageIndex];
  updateImageCounter();
  updateThumbnailSelection();
}

function updateImageCounter() {
  document.getElementById('currentImageIndex').textContent = currentImageIndex + 1;
}

function setupThumbnails(images) {
  if (images.length <= 1) return;
  const thumbnailsContainer = document.getElementById('imageThumbnails');
  thumbnailsContainer.innerHTML = '';
  images.forEach((image, index) => {
    const thumb = document.createElement('img');
    thumb.src = image;
    thumb.className = 'w-16 h-12 object-cover rounded cursor-pointer border-2 border-transparent hover:border-primary transition-colors';
    thumb.onclick = () => { currentImageIndex = index; updateMainImage(); };
    thumbnailsContainer.appendChild(thumb);
  });
  thumbnailsContainer.classList.remove('hidden');
  updateThumbnailSelection();
}

function updateThumbnailSelection() {
  const thumbnails = document.querySelectorAll('#imageThumbnails img');
  thumbnails.forEach((thumb, index) => {
    if (index === currentImageIndex) {
      thumb.classList.remove('border-transparent');
      thumb.classList.add('border-primary');
    } else {
      thumb.classList.add('border-transparent');
      thumb.classList.remove('border-primary');
    }
  });
}

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeProjectModal();
});
</script>
