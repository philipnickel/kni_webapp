{% extends "base.html" %}
{% load wagtailcore_tags wagtailimages_tags wagtailsettings_tags %}

{% block title %}{{ page.title }} - {{ page.get_parent.title }} - {% get_settings as site_settings %}{{ site_settings.pages.SiteSettings.company_name }}{% endblock %}

{# Enhanced Open Graph for projects #}
{% block og_type %}article{% endblock %}

{% block og_image %}
  {% if page.featured_image %}
    {% image page.featured_image width-1200 as project_og_img %}
    <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ project_og_img.url }}" />
    <meta property="og:image:width" content="{{ project_og_img.width }}" />
    <meta property="og:image:height" content="{{ project_og_img.height }}" />
    <meta property="og:image:alt" content="{{ page.title }}" />
  {% else %}
    {{ block.super }}
  {% endif %}
{% endblock %}

{% block twitter_image %}
  {% if page.featured_image %}
    {% image page.featured_image width-1200 as project_twitter_img %}
    <meta name="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ project_twitter_img.url }}" />
    <meta name="twitter:image:alt" content="{{ page.title }}" />
  {% else %}
    {{ block.super }}
  {% endif %}
{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "CreativeWork",
  "name": "{{ page.title|escapejs }}",
  "description": "{% if page.search_description %}{{ page.search_description|escapejs }}{% elif page.description %}{{ page.description|striptags|truncatechars:160|escapejs }}{% else %}Byggeprojekt udført af {{ site_settings.pages.SiteSettings.company_name|default:'vores team'|escapejs }}{% endif %}",
  "url": "{{ request.build_absolute_uri|escapejs }}",
  "creator": {
    "@type": "Organization",
    "name": "{% get_settings as site_settings %}{{ site_settings.pages.SiteSettings.company_name|default:'Company Name'|escapejs }}"
  },
  {% if page.project_date %}
    "dateCreated": "{{ page.project_date|date:'Y-m-d' }}",
    "datePublished": "{{ page.project_date|date:'Y-m-d' }}",
  {% endif %}
  {% if page.featured_image %}
    {% image page.featured_image width-1200 as project_img %}
    "image": "{{ request.scheme }}://{{ request.get_host }}{{ project_img.url }}",
  {% endif %}
  {% if page.tags.all %}
    "keywords": [
      {% for tag in page.tags.all %}"{{ tag.name|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}
    ],
  {% endif %}
  {% if page.location %}
    "locationCreated": {
      "@type": "Place",
      "name": "{{ page.location|escapejs }}"
    },
  {% endif %}
  {% if page.materials %}
    "material": "{{ page.materials|escapejs }}",
  {% endif %}
  "genre": "Construction Project",
  "inLanguage": "da-DK"
}
</script>
{% endblock %}

{% block content %}
  {# Hero Section with Breadcrumb #}
  <div class="bg-gradient-to-br from-slate-50 to-slate-100 -mx-4 px-4 py-12 mb-16">
    <div class="max-w-7xl mx-auto">
      {# Breadcrumb Navigation #}
      {% if page.get_parent %}
        <nav class="mb-8" aria-label="Breadcrumb">
          <div class="flex items-center space-x-2 text-sm">
            <a href="/" class="text-slate-600 hover:text-slate-900 transition-colors">Hjem</a>
            <span class="text-slate-400">•</span>
            <a href="{{ page.get_parent.url }}" class="text-slate-600 hover:text-slate-900 transition-colors">{{ page.get_parent.title }}</a>
            <span class="text-slate-400">•</span>
            <span class="text-slate-900 font-medium">{{ page.title }}</span>
          </div>
        </nav>
      {% endif %}
      
      {# Project Title & Meta Information #}
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
        <div class="flex-1">
          <h1 class="text-4xl lg:text-5xl font-bold text-slate-900 mb-4 leading-tight">{{ page.title }}</h1>
          
          <div class="flex flex-wrap items-center gap-4 mb-6">
            {% if page.project_date %}
              <div class="flex items-center gap-2 text-slate-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span class="font-medium">{{ page.project_date|date:"F Y" }}</span>
              </div>
            {% endif %}
            
            {% if page.location %}
              <div class="flex items-center gap-2 text-slate-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span class="font-medium">{{ page.location }}</span>
              </div>
            {% endif %}
            
            {% if page.featured %}
              <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm bg-amber-100 text-amber-800 border border-amber-200">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                </svg>
                <span class="font-semibold">Fremhævet Projekt</span>
              </div>
            {% endif %}
          </div>
        </div>
        
        {# Hero Image #}
        {% if page.featured_image %}
          <div class="lg:w-96">
            {% image page.featured_image width-400 as hero_image %}
            <div class="relative overflow-hidden rounded-2xl shadow-2xl">
              <img src="{{ hero_image.url }}" alt="{{ page.title }}" class="w-full h-64 lg:h-80 object-cover" />
              <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent"></div>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  {# Main Content #}
  <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-12">
    
    {# Main Content Column #}
    <div class="lg:col-span-2 space-y-12">
      
      {# Project Description #}
      {% if page.description %}
        <section>
          <div class="prose prose-slate prose-lg max-w-none">
            {{ page.description|richtext }}
          </div>
        </section>
      {% endif %}

      {# Project Gallery #}
      {% if page.project_images.all %}
        <section>
          <h2 class="text-3xl font-bold text-slate-900 mb-8">Projekt Galleri</h2>
          
          {# Main featured image #}
          {% for item in page.project_images.all|slice:":1" %}
            {% if item.image %}
              <div class="mb-8">
                {% image item.image width-1200 as main_image %}
                <div class="relative overflow-hidden rounded-2xl shadow-xl">
                  <img src="{{ main_image.url }}" alt="{{ item.alt_text|default:item.caption }}" class="w-full h-96 object-cover" />
                  <div class="absolute inset-0 bg-gradient-to-t from-black/30 via-transparent to-transparent"></div>
                </div>
                {% if item.caption %}
                  <p class="text-slate-600 text-sm mt-4 italic">{{ item.caption }}</p>
                {% endif %}
              </div>
            {% endif %}
          {% endfor %}
          
          {# Additional images grid #}
          {% if page.project_images.all|length > 1 %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              {% for item in page.project_images.all|slice:"1:" %}
                {% if item.image %}
                  <div class="group cursor-pointer" onclick="openLightbox('{{ item.image.url }}', '{{ item.caption|default:item.alt_text }}')">
                    {% image item.image width-600 as gallery_image %}
                    <div class="relative overflow-hidden rounded-xl shadow-lg group-hover:shadow-2xl transition-all duration-300">
                      <img src="{{ gallery_image.url }}" alt="{{ item.alt_text|default:item.caption }}" class="w-full h-64 object-cover group-hover:scale-105 transition-transform duration-300" />
                      <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors duration-300"></div>
                      <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <div class="bg-white/90 backdrop-blur-sm rounded-full p-2">
                          <svg class="w-5 h-5 text-slate-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
                          </svg>
                        </div>
                      </div>
                    </div>
                    {% if item.caption %}
                      <p class="text-slate-600 text-sm mt-3">{{ item.caption }}</p>
                    {% endif %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}
        </section>
      {% endif %}

    </div>
    
    {# Sidebar #}
    <div class="lg:col-span-1">
      <div class="sticky top-8 space-y-8">
        
        {# Project Details Card #}
        {% if page.client_name or page.location or page.materials or page.project_date %}
          <div class="bg-white border border-slate-200 rounded-2xl p-6 shadow-lg">
            <h3 class="text-xl font-bold text-slate-900 mb-6 flex items-center gap-2">
              <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              Projekt Detaljer
            </h3>
            
            <dl class="space-y-4">
              {% if page.project_date %}
                <div class="flex items-start gap-3">
                  <div class="flex-shrink-0 w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center">
                    <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                  </div>
                  <div class="flex-1">
                    <dt class="text-sm font-medium text-slate-500">Færdiggjort</dt>
                    <dd class="text-sm text-slate-900 font-semibold">{{ page.project_date|date:"F Y" }}</dd>
                  </div>
                </div>
              {% endif %}
              
              {% if page.client_name %}
                <div class="flex items-start gap-3">
                  <div class="flex-shrink-0 w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center">
                    <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                  </div>
                  <div class="flex-1">
                    <dt class="text-sm font-medium text-slate-500">Kunde</dt>
                    <dd class="text-sm text-slate-900 font-semibold">{{ page.client_name }}</dd>
                  </div>
                </div>
              {% endif %}
              
              {% if page.location %}
                <div class="flex items-start gap-3">
                  <div class="flex-shrink-0 w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center">
                    <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                  </div>
                  <div class="flex-1">
                    <dt class="text-sm font-medium text-slate-500">Lokation</dt>
                    <dd class="text-sm text-slate-900 font-semibold">{{ page.location }}</dd>
                  </div>
                </div>
              {% endif %}
              
              {% if page.materials %}
                <div class="flex items-start gap-3">
                  <div class="flex-shrink-0 w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center">
                    <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                  </div>
                  <div class="flex-1">
                    <dt class="text-sm font-medium text-slate-500">Materialer</dt>
                    <dd class="text-sm text-slate-900 font-semibold">{{ page.materials }}</dd>
                  </div>
                </div>
              {% endif %}
            </dl>
          </div>
        {% endif %}

        {# Tags Section #}
        {% if page.tags.all %}
          <div class="bg-white border border-slate-200 rounded-2xl p-6 shadow-lg">
            <h3 class="text-xl font-bold text-slate-900 mb-4 flex items-center gap-2">
              <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
              </svg>
              Kategorier
            </h3>
            <div class="flex flex-wrap gap-2">
              {% for tag in page.tags.all %}
                <span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium bg-slate-100 text-slate-700 hover:bg-slate-200 transition-colors">
                  {{ tag.name }}
                </span>
              {% endfor %}
            </div>
          </div>
        {% endif %}
        
        {# Contact CTA Card #}
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 text-white shadow-xl">
          <div class="text-center">
            <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
              </svg>
            </div>
            <h3 class="text-lg font-bold mb-2">Lad os tale om dit projekt</h3>
            <p class="text-slate-300 text-sm mb-4">Interesseret i lignende arbejde? Kontakt os for et uforpligtende tilbud.</p>
            <a href="/kontakt/" class="inline-flex items-center justify-center w-full px-4 py-3 bg-white text-slate-900 rounded-xl font-semibold text-sm hover:bg-slate-50 transition-colors">
              Få et tilbud
              <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
              </svg>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# Related Projects Section #}
  {% if other_projects %}
    <section class="max-w-7xl mx-auto mt-20 pt-16 border-t border-slate-200">
      <div class="text-center mb-12">
        <h2 class="text-3xl lg:text-4xl font-bold text-slate-900 mb-4">Andre Projekter</h2>
        <p class="text-lg text-slate-600 max-w-2xl mx-auto">Udforsk flere eksempler på vores professionelle håndværk og kreative løsninger</p>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
        {% for project in other_projects %}
          <article class="group">
            <a href="{{ project.url }}" class="block">
              <div class="relative overflow-hidden rounded-2xl shadow-lg group-hover:shadow-2xl transition-all duration-300">
                {% if project.featured_image %}
                  {% image project.featured_image fill-400x300 as thumb %}
                  <img src="{{ thumb.url }}" alt="{{ project.title }}" class="w-full h-64 object-cover group-hover:scale-105 transition-transform duration-500" />
                {% else %}
                  <div class="w-full h-64 bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center">
                    <div class="text-center">
                      <svg class="w-12 h-12 text-slate-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                      </svg>
                      <span class="text-slate-500 text-sm">Ingen billede</span>
                    </div>
                  </div>
                {% endif %}
                
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                <div class="absolute bottom-0 left-0 right-0 p-6 text-white transform translate-y-2 group-hover:translate-y-0 transition-transform duration-300">
                  <h3 class="text-lg font-bold mb-1 line-clamp-2">{{ project.title }}</h3>
                  {% if project.project_date %}
                    <p class="text-sm text-white/80">{{ project.project_date|date:"F Y" }}</p>
                  {% endif %}
                </div>
              </div>
            </a>
          </article>
        {% endfor %}
      </div>
      
      <div class="text-center mt-12">
        {% if page.get_parent %}
          <a href="{{ page.get_parent.url }}" class="inline-flex items-center px-8 py-3 bg-slate-900 text-white rounded-xl font-semibold hover:bg-slate-800 transition-colors">
            Se alle projekter
            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
            </svg>
          </a>
        {% endif %}
      </div>
    </section>
  {% endif %}

  {# Lightbox Modal for Gallery Images #}
  <div id="lightbox" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="relative max-w-4xl max-h-full">
      <button onclick="closeLightbox()" class="absolute -top-12 right-0 text-white hover:text-gray-300 transition-colors">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
      <img id="lightboxImage" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg" />
      <p id="lightboxCaption" class="text-white text-center mt-4 text-sm"></p>
    </div>
  </div>

  <script>
    function openLightbox(imageSrc, caption) {
      const lightbox = document.getElementById('lightbox');
      const lightboxImage = document.getElementById('lightboxImage');
      const lightboxCaption = document.getElementById('lightboxCaption');
      
      lightboxImage.src = imageSrc;
      lightboxCaption.textContent = caption || '';
      lightbox.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      const lightbox = document.getElementById('lightbox');
      lightbox.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    // Close lightbox on background click
    document.getElementById('lightbox').addEventListener('click', function(e) {
      if (e.target === this) {
        closeLightbox();
      }
    });

    // Close lightbox on escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeLightbox();
      }
    });
  </script>
{% endblock %}